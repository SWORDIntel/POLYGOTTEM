/*
   YARA Rules for POLYGOTTEM CVE Exploit Detection
   ================================================
   Detects polyglot files and exploit headers generated by POLYGOTTEM

   Author: SWORDIntel
   Date: 2025-11-10
   Version: 2.0 (Extended with 15 new CVEs)

   Usage:
     yara -r cve_exploits.yar /path/to/scan/

   Categories:
   - Priority 1: Critical/actively exploited CVEs
   - Priority 2: High-value legacy CVEs
   - Priority 3: Audio/video format CVEs
   - Multi-format: Polyglot detection rules
*/

import "math"

// ==================== PRIORITY 1 CVEs ====================

rule CVE_2023_4863_WebP_Exploit_Critical {
    meta:
        description = "Detects CVE-2023-4863 libwebp heap overflow exploit (ACTIVELY EXPLOITED)"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "critical"
        reference = "CVE-2023-4863"
        cvss = "8.8"
        exploit_status = "actively_exploited"

    strings:
        $webp_riff = "RIFF" ascii
        $webp_webp = "WEBP" ascii
        $webp_vp8l = "VP8L" ascii wide

        // Huffman overflow markers
        $huffman_15bit = { 00 [0-8] 0F }  // 15-bit code length
        $huffman_overflow = { FF [0-4] FF }  // Maxed out values

        // Payload markers
        $shellcode = "SHELLCODE_EXECUTED_HERE" ascii
        $nop_sled = { 90 90 90 90 90 90 90 90 90 90 }

        // Suspicious VP8L parameters
        $large_dim = { FF 3F [2] FF 3F }  // Max 14-bit dimensions

    condition:
        $webp_riff at 0 and
        $webp_webp and
        $webp_vp8l and
        (
            ($huffman_15bit or $huffman_overflow) or
            ($shellcode or $nop_sled) or
            $large_dim
        ) and
        filesize < 500KB
}

rule CVE_2024_10573_MP3_Frankenstein {
    meta:
        description = "Detects CVE-2024-10573 mpg123 Frankenstein stream exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2024-10573"
        cvss = "6.7"

    strings:
        $mp3_id3 = "ID3" ascii
        $mp3_frame_sync = { FF FB }

        // Different property sets (Frankenstein characteristic)
        $property_44khz_stereo = { FF FB 90 00 }  // 44.1kHz, stereo, 128kbps
        $property_48khz_mono = { FF FB 54 C0 }    // 48kHz, mono, 64kbps
        $property_22khz = { FF FB 74 }            // 22.05kHz

        // Shellcode markers
        $title_frank = "Frankenstein" ascii nocase
        $shellcode_marker = { FF FB F0 00 }  // Custom frame

    condition:
        $mp3_id3 at 0 and
        #mp3_frame_sync > 5 and
        (
            // Multiple property changes indicate Frankenstein stream
            ($property_44khz_stereo and $property_48khz_mono and $property_22khz) or
            ($title_frank or $shellcode_marker)
        ) and
        filesize < 2MB
}

rule CVE_2023_52356_TIFF_Heap_Overflow {
    meta:
        description = "Detects CVE-2023-52356 libtiff heap overflow exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2023-52356"
        cvss = "7.8"

    strings:
        $tiff_le = { 49 49 2A 00 }  // Little endian TIFF
        $tiff_be = { 4D 4D 00 2A }  // Big endian TIFF

        // Malformed dimensions (65535 = 0xFFFF)
        $huge_width = { FF FF 00 00 }
        $huge_height = { FF FF 00 00 }

        // Malformed StripByteCounts
        $huge_byte_count = { F0 FF FF FF }  // 0xFFFFFFF0

        // Tile tags (trigger TIFFReadRGBATileExt path)
        $tile_width_tag = { 42 01 }  // Tag 322
        $tile_length_tag = { 43 01 }  // Tag 323

        $shellcode = "SHELLCODE_EXECUTED_HERE" ascii

    condition:
        ($tiff_le at 0 or $tiff_be at 0) and
        (
            ($huge_width and $huge_height) or
            $huge_byte_count or
            ($tile_width_tag and $tile_length_tag)
        ) and
        (filesize > 1KB and filesize < 1MB)
}

// ==================== PRIORITY 2 CVEs ====================

rule CVE_2017_8373_Libmad_MP3_Heap_Overflow {
    meta:
        description = "Detects CVE-2017-8373 libmad heap overflow exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2017-8373"

    strings:
        $mp3_id3 = "ID3" ascii
        $mp3_layer3 = { FF FB }

        // Malicious side_info with maxed out main_data_begin
        $side_info_overflow = { FF 80 [30] }  // main_data_begin=511

        // 2060 byte overflow payload
        $nop_sled_long = { 90 90 90 90 90 90 90 90 90 90 [50-100] 90 90 90 90 }

    condition:
        $mp3_id3 at 0 and
        $mp3_layer3 and
        ($side_info_overflow or $nop_sled_long) and
        filesize < 500KB
}

rule CVE_2006_0006_WMP_BMP_Heap_Overflow {
    meta:
        description = "Detects CVE-2006-0006 Windows Media Player BMP exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2006-0006"
        target = "Windows Media Player 7.1/9/10"

    strings:
        $bmp_header = "BM" ascii

        // Large dimensions (1024x1024)
        $large_dim = { 00 04 00 00 00 04 00 00 }

        // Oversized color table (512 colors instead of 256)
        $color_table_overflow = { 00 01 00 00 }  // 256 colors declared

        $shellcode = { 48 31 [2-10] 0F 05 }  // x64 shellcode pattern

    condition:
        $bmp_header at 0 and
        (
            $large_dim or
            ($color_table_overflow and filesize > 54 + 2048)  // Header + oversized table
        ) and
        filesize < 1MB
}

rule CVE_2020_22219_FLAC_Encoder_Overflow {
    meta:
        description = "Detects CVE-2020-22219 FLAC encoder buffer overflow"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2020-22219"
        cvss = "7.8"

    strings:
        $flac_marker = "fLaC" ascii

        // STREAMINFO with overflow-triggering parameters
        $huge_blocksize = { FF FF }  // max_blocksize = 65535
        $huge_framesize = { FF FF FF }
        $huge_samples = { FF FF FF FF FF }

        // APPLICATION block with shellcode marker
        $app_block = { 82 [3] 53 48 45 4C }  // "SHEL"

        $shellcode = "SHELLCODE_EXECUTED_HERE" ascii

    condition:
        $flac_marker at 0 and
        (
            ($huge_blocksize and $huge_framesize) or
            ($app_block or $shellcode)
        ) and
        filesize < 500KB
}

rule CVE_2020_0499_FLAC_Decoder_OOB_Read {
    meta:
        description = "Detects CVE-2020-0499 FLAC decoder OOB read exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "medium"
        reference = "CVE-2020-0499"
        cvss = "6.5"

    strings:
        $flac_marker = "fLaC" ascii
        $frame_sync = { FF F8 }

        // Malformed Rice partition with large order
        $rice_overflow = { F0 [4-32] 1F }  // Order 15, max parameters

        $shellcode = { 48 31 [2-10] 0F 05 }

    condition:
        $flac_marker at 0 and
        $frame_sync and
        ($rice_overflow or $shellcode) and
        filesize < 500KB
}

rule CVE_2008_1083_GDI_WMF_Heap_Overflow {
    meta:
        description = "Detects CVE-2008-1083 Windows GDI WMF/EMF heap overflow"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "critical"
        reference = "CVE-2008-1083"
        target = "Windows GDI"

    strings:
        $wmf_magic = { D7 CD C6 9A }  // Placeable WMF header
        $wmf_header = { 01 00 09 00 }  // WMF header (type 1, size 9)

        // Malformed max record size (integer overflow trigger)
        $max_record_overflow = { FF FF FF FF }

        // Huge window extents
        $huge_extent = { FF FF FF FF }

        $shellcode = { 48 [2-20] 0F 05 }

    condition:
        $wmf_magic at 0 and
        $wmf_header and
        (
            $max_record_overflow or
            $huge_extent
        ) and
        filesize < 1MB
}

rule CVE_2005_4560_WMF_SETABORTPROC {
    meta:
        description = "Detects CVE-2005-4560 WMF SETABORTPROC exploit (classic)"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "critical"
        reference = "CVE-2005-4560"
        exploit_status = "widely_exploited_2005_2006"

    strings:
        $wmf_magic = { D7 CD C6 9A }

        // SETABORTPROC record (function 0x0105)
        $setabortproc = { [4] 05 01 }

        // NOP sled (indicates shellcode)
        $nop_sled = { 90 90 90 90 90 90 90 90 90 90 }

        $shellcode_pattern = { 48 [2-10] 0F 05 }

    condition:
        $wmf_magic at 0 and
        $setabortproc and
        ($nop_sled or $shellcode_pattern) and
        filesize < 1MB
}

// ==================== PRIORITY 3 CVEs ====================

rule CVE_2017_6827_Audiofile_WAV_MSADPCM {
    meta:
        description = "Detects CVE-2017-6827 audiofile MSADPCM heap overflow"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2017-6827"

    strings:
        $riff = "RIFF" ascii
        $wave = "WAVE" ascii
        $fmt = "fmt " ascii

        // MSADPCM format (0x0002)
        $msadpcm = { 02 00 }

        // Malformed coefficient count (should be 7, we use 256)
        $coef_overflow = { 00 01 }  // 256 in little-endian

        $data_chunk = "data" ascii

    condition:
        $riff at 0 and
        $wave and
        $fmt and
        $msadpcm and
        $coef_overflow and
        filesize < 1MB
}

rule CVE_2018_5146_Libvorbis_OGG_OOB_Write {
    meta:
        description = "Detects CVE-2018-5146 libvorbis OOB write exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2018-5146"
        impact = "Browser crashes, possible RCE"

    strings:
        $ogg_magic = "OggS" ascii
        $vorbis_id = "vorbis" ascii

        // Malformed block sizes (0xF0 = both max)
        $bad_blocksize = { F0 }

        // Excessive codebook count (0xFF = 256)
        $codebook_overflow = { FF }

        $shellcode = { 48 31 [2-10] 0F 05 }

    condition:
        $ogg_magic at 0 and
        $vorbis_id and
        (
            $bad_blocksize or
            $codebook_overflow
        ) and
        filesize < 500KB
}

rule CVE_2022_22675_AppleAVD_Video_Overflow {
    meta:
        description = "Detects CVE-2022-22675 AppleAVD buffer overflow (iOS jailbreak)"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "critical"
        reference = "CVE-2022-22675"
        target = "iOS/macOS AppleAVD kernel driver"

    strings:
        $mp4_ftyp = "ftyp" ascii
        $mp4_mdat = "mdat" ascii

        // H.264 NAL unit start code
        $nal_start = { 00 00 00 01 65 }  // IDR slice

        // Malformed prediction weight table
        $pred_weight_overflow = { FF FF [8-128] 41 41 }  // Max denoms + controlled writes

        $shellcode = { 48 [2-20] 0F 05 }

    condition:
        $mp4_ftyp and
        $mp4_mdat and
        $nal_start and
        ($pred_weight_overflow or $shellcode) and
        filesize < 2MB
}

rule CVE_2021_0561_FLAC_Encoder_OOB {
    meta:
        description = "Detects CVE-2021-0561 FLAC encoder OOB write"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "medium"
        reference = "CVE-2021-0561"

    strings:
        $flac = "fLaC" ascii

        // Max blocksize (65535)
        $max_blocksize = { FF FF FF FF }

        // 192kHz sample rate (upper limit)
        $high_samplerate = { 00 EE 00 }  // 192000 Hz

        // 8 channels, 32-bit
        $max_channels_bits = { E0 FF }

    condition:
        $flac at 0 and
        (
            ($max_blocksize and $high_samplerate) or
            $max_channels_bits
        ) and
        filesize < 500KB
}

rule CVE_2017_11126_MPG123_Intensity_Stereo {
    meta:
        description = "Detects CVE-2017-11126 mpg123 intensity stereo overflow"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "medium"
        reference = "CVE-2017-11126"

    strings:
        $mp3_id3 = "ID3" ascii
        $mp3_sync = { FF FB }

        // Joint stereo with intensity stereo on (0x50)
        $intensity_stereo = { 90 50 }

        // Maxed out side_info (overflow trigger)
        $side_info_max = { FF FF [30] }

        $shellcode = { 48 [2-10] 0F 05 }

    condition:
        $mp3_id3 at 0 and
        $mp3_sync and
        $intensity_stereo and
        ($side_info_max or $shellcode) and
        filesize < 1MB
}

rule CVE_2021_40426_Libsox_SPHERE_Overflow {
    meta:
        description = "Detects CVE-2021-40426 libsox SPHERE file heap overflow"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "CVE-2021-40426"

    strings:
        $sphere_magic = "NIST_1A" ascii
        $sphere_header_size = "   1024" ascii

        // Malformed fields
        $huge_channel = "channel_count -i 65535" ascii
        $huge_samples = "sample_count -i 4294967295" ascii
        $huge_bytes = "sample_n_bytes -i 1048576" ascii

        // Overflow trigger
        $malformed_field = "malformed_field -s999999" ascii

        $end_head = "end_head" ascii

    condition:
        $sphere_magic at 0 and
        $sphere_header_size and
        (
            ($huge_channel and $huge_samples) or
            $malformed_field
        ) and
        $end_head and
        filesize < 1MB
}

// ==================== MULTI-FORMAT POLYGLOT DETECTION ====================

rule POLYGOTTEM_Multi_Format_Polyglot {
    meta:
        description = "Detects multi-format polyglot files with embedded CVE exploits"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "POLYGOTTEM tool signature"

    strings:
        // Image formats
        $gif = "GIF89a" ascii
        $jpeg = { FF D8 FF }
        $png = { 89 50 4E 47 0D 0A 1A 0A }
        $webp = "RIFF" ascii wide
        $tiff_le = { 49 49 2A 00 }
        $tiff_be = { 4D 4D 00 2A }
        $bmp = "BM" ascii

        // Audio formats
        $mp3 = "ID3" ascii
        $flac = "fLaC" ascii
        $ogg = "OggS" ascii
        $wav = "RIFF" ascii wide

        // Container formats
        $pdf = "%PDF" ascii
        $zip = "PK" ascii

        // XOR encryption marker (TeamTNT signature)
        $xor_key = { 9E 0A 61 20 0D }

        // Shellcode markers
        $shellcode_marker = "SHELLCODE_EXECUTED_HERE" ascii
        $nop_sled = { 90 90 90 90 90 90 90 90 90 90 }

    condition:
        // At least 3 different format signatures
        (
            (#gif + #jpeg + #png + #webp + #tiff_le + #tiff_be + #bmp +
             #mp3 + #flac + #ogg + #wav + #pdf + #zip) >= 3
        ) and
        (
            $xor_key or
            $shellcode_marker or
            $nop_sled
        ) and
        filesize < 10MB
}

rule POLYGOTTEM_XOR_Encrypted_Payload {
    meta:
        description = "Detects XOR-encrypted payloads in polyglot files"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "medium"
        reference = "TeamTNT XOR encryption"

    strings:
        // Known TeamTNT XOR keys
        $xor_key_1 = { 9E 0A 61 20 0D }
        $xor_key_2 = { D3 }
        $xor_key_3 = { A5 }
        $xor_key_4 = { 41 0D 20 0D }

        // High entropy after EOF markers
        $gif_eof = { 00 3B }
        $jpeg_eof = { FF D9 }
        $png_eof = "IEND" ascii

    condition:
        (
            $xor_key_1 or
            $xor_key_2 or
            $xor_key_3 or
            $xor_key_4
        ) and
        (
            ($gif_eof and math.entropy(filesize - 1024, 1024) > 7.5) or
            ($jpeg_eof and math.entropy(filesize - 1024, 1024) > 7.5) or
            ($png_eof and math.entropy(filesize - 1024, 1024) > 7.5)
        ) and
        filesize > 10KB
}

rule POLYGOTTEM_Suspicious_Desktop_File {
    meta:
        description = "Detects malicious .desktop files for auto-execution"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"
        reference = "XDG Desktop Entry exploitation"

    strings:
        $desktop_entry = "[Desktop Entry]" ascii
        $exec = "Exec=" ascii
        $type_app = "Type=Application" ascii

        // Suspicious commands
        $bash = "/bin/bash" ascii
        $sh = "/bin/sh" ascii
        $python = "python" ascii
        $extract = "polyglot_extract" ascii
        $xor = "xor" ascii nocase

        // Hidden file execution
        $hidden = "NoDisplay=true" ascii

    condition:
        $desktop_entry at 0 and
        $exec and
        $type_app and
        (
            ($bash or $sh or $python) and
            ($extract or $xor)
        ) and
        filesize < 10KB
}

// ==================== SUMMARY RULE ====================

rule POLYGOTTEM_CVE_Exploit_Comprehensive {
    meta:
        description = "Comprehensive detection for any POLYGOTTEM-generated CVE exploit"
        author = "SWORDIntel"
        date = "2025-11-10"
        severity = "high"

    strings:
        // File type markers
        $marker_image = { FF D8 FF } or { 89 50 4E 47 } or { 47 49 46 }
        $marker_audio = "ID3" or "fLaC" or "OggS" or "RIFF"
        $marker_video = "ftyp" or "mdat"

        // Exploit indicators
        $overflow_marker = { FF FF FF FF }
        $huge_dimension = { FF 3F } or { FF FF 00 00 }
        $nop_sled = { 90 90 90 90 90 90 90 90 }
        $shellcode = "SHELLCODE_EXECUTED_HERE"
        $xor_key = { 9E 0A 61 20 0D }

        // Malformed structures
        $bad_size = { F0 FF FF FF } or { FF FF FF 00 }
        $overflow_count = { 00 01 } or { FF 00 }

    condition:
        (
            $marker_image or
            $marker_audio or
            $marker_video
        ) and
        (
            2 of ($overflow_marker, $huge_dimension, $nop_sled, $shellcode, $xor_key, $bad_size, $overflow_count)
        ) and
        filesize < 10MB
}
